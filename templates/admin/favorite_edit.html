{% extends 'admin/base.html' %}

{% block subtitle %}Favoriyi Düzenle{% endblock %}

{% block admin_content %}
<div class="admin-page-header">
    <h1><i class="fas fa-edit"></i> Favoriyi Düzenle</h1>
    <p class="header-subtitle">'{{ favorite.title }}' başlıklı favoriyi düzenleyin</p>
</div>

<div class="content-card edit-favorite-form">
    <div class="card-body">
        <form action="{{ url_for('admin_edit_favorite', favorite_id=favorite.id) }}" method="POST" enctype="multipart/form-data" class="p-4 bg-white rounded-lg shadow-md" id="edit-favorite-form">
            <div class="form-group">
                <label for="title"><i class="fas fa-heading"></i> Başlık</label>
                <input type="text" id="title" name="title" class="form-control" value="{{ favorite.title }}" required>
            </div>
            <div class="form-group">
                <label for="description"><i class="fas fa-align-left"></i> Açıklama Metni</label>
                <textarea id="description" name="description" class="form-control" rows="4">{{ favorite.description or '' }}</textarea>
            </div>
            <div class="form-group">
                <p class="text-sm text-gray-500"><i class="fas fa-info-circle"></i> Yeni resimler ekleyebilirsiniz. Mevcut resimleri kaldırmak için üzerine tıklayın.</p>
            </div>

            <!-- Existing Images -->
            <div class="form-group">
                <label><i class="fas fa-images"></i> Mevcut Resimler</label>
                <div id="existing-images-preview" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mt-2">
                    {% for image in images %}
                    <div class="existing-image-preview" data-image-id="{{ image.id }}" id="image-{{ image.id }}">
                        <img src="{{ url_for('static', filename='images/' + image.image_filename) }}" alt="Mevcut Resim" class="w-full h-auto rounded-lg shadow-md">
                        <button type="button" class="remove-image-btn" title="Resmi Sil">&times;</button>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- New Image Upload -->
            <div class="form-group">
                <label for="images"><i class="fas fa-upload"></i> Yeni Resimler Ekle</label>
                <div class="file-upload-area">
                    <input type="file" id="images" name="images" multiple accept="image/*" class="hidden">
                    <label for="images" class="file-upload-label">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>Dosyaları buraya sürükleyin veya seçmek için tıklayın</span>
                    </label>
                </div>
                <div id="new-images-preview" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mt-4"></div>
            </div>

            <div class="form-group text-right">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Değişiklikleri Kaydet</button>
                <a href="{{ url_for('admin_favorites_manage') }}" class="btn btn-secondary"><i class="fas fa-times"></i> İptal</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block admin_extra_css %}
<style>
.edit-favorite-form {
    max-width: 800px;
    margin: 30px auto;
}
.grid {
    display: grid;
}
.grid-cols-2 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
}
.grid-cols-4 {
    grid-template-columns: repeat(4, minmax(0, 1fr));
}
.grid-cols-6 {
    grid-template-columns: repeat(6, minmax(0, 1fr));
}
.gap-4 {
    gap: 1rem;
}
.mt-2 {
    margin-top: 0.5rem;
}
.mt-4 {
    margin-top: 1rem;
}
.existing-image-preview {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--admin-border);
    aspect-ratio: 1;
}
.existing-image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.remove-image-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    background: rgba(0,0,0,0.7);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    line-height: 24px;
    text-align: center;
    opacity: 0;
    transition: opacity 0.2s ease;
}
.existing-image-preview:hover .remove-image-btn {
    opacity: 1;
}
.file-upload-area {
    position: relative;
    border: 2px dashed var(--admin-border);
    border-radius: 12px;
    padding: 40px 20px;
    text-align: center;
    background: var(--admin-bg-secondary);
    transition: all 0.3s ease;
    cursor: pointer;
}
.file-upload-area.dragging {
    border-color: var(--admin-accent);
    background: var(--admin-surface-hover);
}
.file-input {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;
}
.file-upload-label {
    display: flex; flex-direction: column; align-items: center; gap: 12px; color: var(--admin-text-secondary);
}
.file-upload-label i { font-size: 32px; color: var(--admin-accent); }
.form-actions {
    margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--admin-border); display: flex; gap: 15px;
}
</style>
{% endblock %}

{% block admin_extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- EXISTING IMAGE REMOVAL SCRIPT ---
    document.querySelectorAll('.remove-image-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const imageContainer = this.closest('.existing-image-preview');
            const imageId = imageContainer.dataset.imageId;
            
            if (confirm('Bu resmi kalıcı olarak silmek istediğinizden emin misiniz?')) {
                fetch(`/admin/favorites/delete_image/${imageId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // 'X-CSRF-Token': '{{ csrf_token() }}' // Add if you use Flask-WTF
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        imageContainer.remove();
                    } else {
                        alert('Resim silinemedi: ' + (data.error || 'Bilinmeyen hata'));
                    }
                })
                .catch(error => {
                    console.error('Hata:', error);
                    alert('Resim silinirken bir sunucu hatası oluştu.');
                });
            }
        });
    });

    // --- NEW IMAGE UPLOAD SCRIPT ---
    const fileInput = document.getElementById('images');
    const fileUploadArea = document.querySelector('.file-upload-area');
    const newImagesPreview = document.getElementById('new-images-preview');

    function displayPreviews(files) {
        newImagesPreview.innerHTML = '';
        if (files && files.length > 0) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewContainer = document.createElement('div');
                        previewContainer.classList.add('new-image-preview');
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        
                        previewContainer.appendChild(img);
                        newImagesPreview.appendChild(previewContainer);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    }

    fileInput.addEventListener('change', () => {
        displayPreviews(fileInput.files);
    });

    fileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadArea.classList.add('dragging');
    });

    fileUploadArea.addEventListener('dragleave', () => {
        fileUploadArea.classList.remove('dragging');
    });

    fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.classList.remove('dragging');
        const files = e.dataTransfer.files;
        fileInput.files = files; // Assign dropped files to input
        displayPreviews(files);
    });

    // --- SUBMIT BUTTON SPINNER & DISABLE ---
    const form = document.getElementById('edit-favorite-form');
    if (form) {
        form.addEventListener('submit', function() {
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';
                submitBtn.disabled = true;
            }
        });
    }
});
</script>
{% endblock %}
